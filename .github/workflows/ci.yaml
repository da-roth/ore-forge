##############################################################################
#
#  ORE-Forge CI Workflow
#
#  Builds QuantLib (from ORE) with XAD-JIT + Forge integration.
#
#  This requires patching ORE's QuantLib to fix constexpr incompatibility
#  with XAD's non-literal Real type.
#
#  Based on QuantLib-Risks-Cpp-Forge CI workflow.
#
#  Copyright (C) 2025 The ORE-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  # Pinned versions
  ore_version: v1.8.14.0
  xad_commit: ed10eeec8c0414e495f1b64f48c9b87aa2c1eecc
  forge_commit: 8fead7cc0eade88448c052ebd3c579f858e1edfa
  qlrisks_commit: 6c331dc034e25756f0d4263c0aa7a5035c177255

jobs:
  ##############################################################################
  # Build QuantLib (from ORE) with XAD-JIT + Forge
  ##############################################################################
  quantlib-xad-forge:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling
    name: "QuantLib (ORE) + XAD + Forge"

    steps:
      # Get QuantLib from ORE Engine's submodule
      - name: Checkout ORE Engine
        uses: actions/checkout@v4
        with:
          repository: OpenSourceRisk/Engine
          ref: ${{ env.ore_version }}
          path: Engine
          submodules: false

      - name: Checkout QuantLib submodule
        run: |
          cd Engine
          git submodule update --init QuantLib

      - name: Move QuantLib to workspace root
        run: mv Engine/QuantLib QuantLib

      - name: Checkout XAD-JIT
        uses: actions/checkout@v4
        with:
          repository: da-roth/xad-jit
          ref: ${{ env.xad_commit }}
          path: xad-jit

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/forge
          ref: ${{ env.forge_commit }}
          path: forge

      - name: Checkout QuantLib-Risks-Cpp-Forge
        uses: actions/checkout@v4
        with:
          repository: da-roth/QuantLib-Risks-Cpp-Forge
          ref: ${{ env.qlrisks_commit }}
          path: QuantLib-Risks-Cpp-Forge

      - name: Patch QuantLib for XAD compatibility
        run: |
          # Fix constexpr Real incompatibility with XAD's non-literal type
          # XAD's AReal<double> has a non-trivial destructor, so cannot be constexpr
          cd QuantLib
          sed -i 's/constexpr Real tolerance = 42 \* QL_EPSILON;/const Real tolerance = 42 * QL_EPSILON;/g' ql/math/comparison.hpp
          echo "Patched ql/math/comparison.hpp:"
          grep -n "tolerance = 42" ql/math/comparison.hpp

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: quantlib-xad-forge
          max-size: 1G

      - name: Setup
        run: apt-get update && apt-get install -y ninja-build ccache

      - name: Build Forge
        run: |
          cd forge
          cmake -B build -S tools/packaging -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Configure QuantLib with XAD-JIT + Forge
        run: |
          cd QuantLib
          cmake -B build -G Ninja \
            -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad-jit;$(pwd)/../QuantLib-Risks-Cpp-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_BUILD_TEST_SUITE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON

      - name: Build QuantLib
        run: cmake --build QuantLib/build --parallel

      - name: Run QuantLib-Risks Tests
        run: ./QuantLib/build/QuantLib-Risks-Cpp-Forge/test-suite/quantlib-risks-test-suite --log_level=message

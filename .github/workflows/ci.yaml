##############################################################################
#
#  ORE-Forge CI Workflow
#
#  Builds QuantLib (from ORE) with XAD-JIT (Forge-enabled) and runs the
#  QuantLib-Risks test suite including Forge JIT tests.
#
#  This is a fork of QuantLib-Risks-Cpp-Forge adapted to use ORE's QuantLib
#  fork with patches for XAD compatibility.
#
#  This workflow:
#  1. Gets QuantLib from ORE Engine's submodule
#  2. Applies patches for XAD compatibility (constexpr -> const)
#  3. Builds Forge as a pre-built package (isolates AVX2 flags)
#  4. Configures QuantLib with XAD-JIT + ORE-Forge
#  5. Runs the quantlib-risks-test-suite with Forge tests enabled
#
#  Copyright (C) 2025 The ORE-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      ore_repo:
        description: ORE Engine repository in <owner>/<repo> format
        required: true
        default: OpenSourceRisk/Engine
      ore_branch:
        description: Branch or tag for ORE Engine repository
        required: true
        default: v1.8.14.0
      xad_repo:
        description: XAD-JIT repository in <owner>/<repo> format
        required: true
        default: da-roth/xad-jit
      xad_branch:
        description: Branch or tag for XAD-JIT repository
        required: true
        default: main
      forge_repo:
        description: Forge repository in <owner>/<repo> format
        required: true
        default: da-roth/forge
      forge_branch:
        description: Branch or tag for Forge repository
        required: true
        default: main

env:
  ore_repo: ${{ github.event.inputs.ore_repo || 'OpenSourceRisk/Engine' }}
  ore_branch: ${{ github.event.inputs.ore_branch || 'v1.8.14.0' }}
  xad_repo: ${{ github.event.inputs.xad_repo || 'da-roth/xad-jit' }}
  xad_branch: ${{ github.event.inputs.xad_branch || 'main' }}
  forge_repo: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  forge_branch: ${{ github.event.inputs.forge_branch || 'main' }}

jobs:
  linux-forge:
    strategy:
      fail-fast: false
      matrix:
        build_type: ["Release", "Debug"]
        capi: [off, on]
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    name: Linux ${{ matrix.build_type }} (${{ matrix.capi == 'on' && 'C API' || 'C++ API' }})

    steps:
      # Get QuantLib from ORE Engine's submodule (instead of lballabio/QuantLib)
      - name: Checkout ORE Engine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ore_repo }}
          ref: ${{ env.ore_branch }}
          path: Engine
          submodules: false

      - name: Checkout QuantLib submodule
        run: |
          cd Engine
          git submodule update --init QuantLib

      - name: Move QuantLib to workspace root
        run: mv Engine/QuantLib QuantLib

      - name: Checkout XAD-JIT
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad-jit

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.forge_repo }}
          ref: ${{ env.forge_branch }}
          path: forge

      # Checkout ORE-Forge (this repo - contains qlrisks.hpp, ForgeBackend, tests)
      - name: Checkout ORE-Forge
        uses: actions/checkout@v4
        with:
          path: ORE-Forge

      # Apply patches for XAD compatibility
      - name: Apply patches to QuantLib
        run: |
          cd QuantLib
          echo "Applying ORE-Forge patches..."
          for patch in ../ORE-Forge/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying: $patch"
              git apply "$patch"
            fi
          done
          echo "Patches applied. Verifying:"
          grep -n "const Real tolerance" ql/math/comparison.hpp | head -2

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-forge-${{ matrix.build_type }}-${{ matrix.capi }}
          max-size: 650M

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build ccache

      - name: Build Forge (C++ API)
        if: matrix.capi == 'off'
        run: |
          cd forge
          cmake -B build -S tools/packaging \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build --config ${{ matrix.build_type }}
          cmake --install build --config ${{ matrix.build_type }}

      - name: Build Forge (C API)
        if: matrix.capi == 'on'
        run: |
          cd forge
          cmake -B build -S tools/capi \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build --config ${{ matrix.build_type }}
          cmake --install build --config ${{ matrix.build_type }}

      - name: Configure QuantLib with XAD-JIT + Forge (C++ API)
        if: matrix.capi == 'off'
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DCMAKE_PREFIX_PATH=$(pwd)/../../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../../xad-jit;$(pwd)/../../ORE-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_BUILD_TEST_SUITE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON \
            ..

      - name: Configure QuantLib with XAD-JIT + Forge (C API)
        if: matrix.capi == 'on'
        run: |
          cd QuantLib
          mkdir build
          cd build
          cmake -G Ninja -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DCMAKE_PREFIX_PATH=$(pwd)/../../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../../xad-jit;$(pwd)/../../ORE-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_USE_FORGE_CAPI=ON \
            -DQLRISKS_BUILD_TEST_SUITE=ON \
            -DQLRISKS_ENABLE_FORGE_TESTS=ON \
            ..

      - name: Build
        run: |
          cd QuantLib/build
          cmake --build .

      - name: Test QuantLib-Risks
        run: |
          cd QuantLib/build
          ./ORE-Forge/test-suite/quantlib-risks-test-suite --log_level=message

##############################################################################
#
#  ORE-Forge CI Workflow
#
#  Builds ORE (Open Source Risk Engine) with XAD-JIT and Forge integration
#  for accelerated pricing and AAD-based sensitivities.
#
#  Jobs:
#  1. ore-original-pinned: Baseline ORE build with pinned QuantLib (v1.8.14.0)
#  2. ore-original-ql-master: ORE build with QuantLib master (compatibility test)
#  3. ore-forge: ORE with XAD-JIT + Forge integration
#
#  Copyright (C) 2025 The ORE-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      ore_repo:
        description: ORE Engine repository in <owner>/<repo> format
        required: true
        default: OpenSourceRisk/Engine
      ore_branch:
        description: Branch, tag, or commit for ORE Engine repository
        required: true
        default: v1.8.14.0
      xad_repo:
        description: XAD-JIT repository in <owner>/<repo> format
        required: true
        default: da-roth/xad-jit
      xad_branch:
        description: Branch, tag, or commit for XAD-JIT repository
        required: true
        default: ed10eeec8c0414e495f1b64f48c9b87aa2c1eecc
      forge_repo:
        description: Forge repository in <owner>/<repo> format
        required: true
        default: da-roth/forge
      forge_branch:
        description: Branch, tag, or commit for Forge repository
        required: true
        default: 8fead7cc0eade88448c052ebd3c579f858e1edfa
      qlrisks_repo:
        description: QuantLib-Risks-Cpp-Forge repository in <owner>/<repo> format
        required: true
        default: da-roth/QuantLib-Risks-Cpp-Forge
      qlrisks_branch:
        description: Branch, tag, or commit for QuantLib-Risks-Cpp-Forge repository
        required: true
        default: 6c331dc034e25756f0d4263c0aa7a5035c177255

env:
  # ORE v1.8.14.0 - stable release with pinned QuantLib submodule
  ore_repo: ${{ github.event.inputs.ore_repo || 'OpenSourceRisk/Engine' }}
  ore_branch: ${{ github.event.inputs.ore_branch || 'v1.8.14.0' }}
  # XAD-JIT - pinned commit (no tags available)
  xad_repo: ${{ github.event.inputs.xad_repo || 'da-roth/xad-jit' }}
  xad_branch: ${{ github.event.inputs.xad_branch || 'ed10eeec8c0414e495f1b64f48c9b87aa2c1eecc' }}
  # Forge - pinned commit (no tags available)
  forge_repo: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  forge_branch: ${{ github.event.inputs.forge_branch || '8fead7cc0eade88448c052ebd3c579f858e1edfa' }}
  # QuantLib-Risks-Cpp-Forge - pinned commit
  qlrisks_repo: ${{ github.event.inputs.qlrisks_repo || 'da-roth/QuantLib-Risks-Cpp-Forge' }}
  qlrisks_branch: ${{ github.event.inputs.qlrisks_branch || '6c331dc034e25756f0d4263c0aa7a5035c177255' }}

jobs:
  ##############################################################################
  # Baseline: ORE with pinned QuantLib (v1.8.14.0)
  # This should always pass - establishes that ORE itself builds correctly
  ##############################################################################
  ore-original-pinned:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling
    name: ORE Original (Pinned QL v1.8.14.0)

    steps:
      - name: Checkout ORE Engine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ore_repo }}
          ref: ${{ env.ore_branch }}
          path: Engine
          submodules: recursive

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-ore-original-pinned
          max-size: 1G

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build ccache

      - name: Configure ORE
        run: |
          cd Engine
          cmake -B build -G Ninja \
            -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DORE_BUILD_DOC=OFF \
            -DORE_BUILD_EXAMPLES=OFF \
            -DORE_BUILD_TESTS=ON \
            -DORE_BUILD_APP=ON \
            -DORE_BUILD_SWIG=OFF

      - name: Build ORE
        run: |
          cd Engine/build
          cmake --build . --parallel

      - name: Run QuantExt Tests
        run: |
          cd Engine/build
          ./QuantExt/test/quantext-test-suite --log_level=message

      - name: Run OREData Tests
        run: |
          cd Engine/build
          ./OREData/test/ored-test-suite --log_level=message

      - name: Run OREAnalytics Tests
        run: |
          cd Engine/build
          ./OREAnalytics/test/orea-test-suite --log_level=message

  ##############################################################################
  # Compatibility test: ORE with QuantLib master
  # Tests if ORE is compatible with latest QuantLib - may fail
  ##############################################################################
  ore-original-ql-master:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling
    name: ORE Original (QL master)
    continue-on-error: true  # This job may fail - it's informational

    steps:
      - name: Checkout ORE Engine (without submodules)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ore_repo }}
          ref: ${{ env.ore_branch }}
          path: Engine
          submodules: false

      - name: Checkout QuantLib master
        uses: actions/checkout@v4
        with:
          repository: lballabio/QuantLib
          ref: master
          path: Engine/QuantLib

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-ore-original-ql-master
          max-size: 1G

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build ccache

      - name: Configure ORE
        run: |
          cd Engine
          cmake -B build -G Ninja \
            -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DORE_BUILD_DOC=OFF \
            -DORE_BUILD_EXAMPLES=OFF \
            -DORE_BUILD_TESTS=ON \
            -DORE_BUILD_APP=ON \
            -DORE_BUILD_SWIG=OFF

      - name: Build ORE
        run: |
          cd Engine/build
          cmake --build . --parallel

      - name: Run QuantExt Tests
        run: |
          cd Engine/build
          ./QuantExt/test/quantext-test-suite --log_level=message

      - name: Run OREData Tests
        run: |
          cd Engine/build
          ./OREData/test/ored-test-suite --log_level=message

      - name: Run OREAnalytics Tests
        run: |
          cd Engine/build
          ./OREAnalytics/test/orea-test-suite --log_level=message

  ##############################################################################
  # ORE + XAD-JIT + Forge integration
  # Uses lballabio/QuantLib (same as QuantLib-Risks-Cpp-Forge CI) to ensure
  # XAD integration works with a known-good QuantLib version
  ##############################################################################
  ore-forge:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling
    name: ORE + XAD-JIT + Forge

    steps:
      - name: Checkout ORE Engine (without QuantLib submodule)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ore_repo }}
          ref: ${{ env.ore_branch }}
          path: Engine
          submodules: false

      - name: Checkout QuantLib (lballabio/QuantLib - same as QuantLib-Risks-Cpp-Forge)
        uses: actions/checkout@v4
        with:
          repository: lballabio/QuantLib
          ref: master
          path: Engine/QuantLib

      - name: Checkout XAD-JIT
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad-jit

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.forge_repo }}
          ref: ${{ env.forge_branch }}
          path: forge

      - name: Checkout QuantLib-Risks-Cpp-Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.qlrisks_repo }}
          ref: ${{ env.qlrisks_branch }}
          path: QuantLib-Risks-Cpp-Forge

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: linux-ore-forge
          max-size: 1G

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build ccache

      - name: Build Forge
        run: |
          cd forge
          cmake -B build -S tools/packaging \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      - name: Configure ORE with XAD-JIT + Forge
        run: |
          cd Engine
          cmake -B build -G Ninja \
            -DBOOST_ROOT=/usr \
            -DCMAKE_CXX_STANDARD=20 \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad-jit;$(pwd)/../QuantLib-Risks-Cpp-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DORE_BUILD_DOC=OFF \
            -DORE_BUILD_EXAMPLES=OFF \
            -DORE_BUILD_TESTS=ON \
            -DORE_BUILD_APP=ON \
            -DORE_BUILD_SWIG=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_BUILD_TEST_SUITE=OFF \
            -DQLRISKS_ENABLE_FORGE_TESTS=OFF

      - name: Build ORE
        run: |
          cd Engine/build
          cmake --build . --parallel

      - name: Run QuantExt Tests
        run: |
          cd Engine/build
          ./QuantExt/test/quantext-test-suite --log_level=message || true

      - name: Run OREData Tests
        run: |
          cd Engine/build
          ./OREData/test/ored-test-suite --log_level=message || true

      - name: Run OREAnalytics Tests
        run: |
          cd Engine/build
          ./OREAnalytics/test/orea-test-suite --log_level=message || true

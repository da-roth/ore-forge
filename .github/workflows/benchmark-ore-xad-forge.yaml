##############################################################################
#
#  ORE Example 3 CVA Benchmark - XAD JIT with Forge
#
#  Builds ORE with XAD-JIT and Forge, runs Example 3 CVA benchmark.
#  Uses JIT compilation for accelerated derivative computation.
#
#  Copyright (C) 2025 The ORE-Forge Authors
#
#  SPDX-License-Identifier: AGPL-3.0-or-later
#
##############################################################################

name: Benchmark ORE XAD+Forge

on:
  workflow_dispatch:
    inputs:
      ore_repo:
        description: ORE Engine repository
        required: true
        default: OpenSourceRisk/Engine
      ore_branch:
        description: Branch or tag for ORE Engine
        required: true
        default: v1.8.14.0
      xad_repo:
        description: XAD-JIT repository
        required: true
        default: da-roth/xad-jit
      xad_branch:
        description: Branch for XAD-JIT
        required: true
        default: main
      forge_repo:
        description: Forge repository
        required: true
        default: da-roth/forge
      forge_branch:
        description: Branch for Forge
        required: true
        default: main

env:
  ore_repo: ${{ github.event.inputs.ore_repo || 'OpenSourceRisk/Engine' }}
  ore_branch: ${{ github.event.inputs.ore_branch || 'v1.8.14.0' }}
  xad_repo: ${{ github.event.inputs.xad_repo || 'da-roth/xad-jit' }}
  xad_branch: ${{ github.event.inputs.xad_branch || 'main' }}
  forge_repo: ${{ github.event.inputs.forge_repo || 'da-roth/forge' }}
  forge_branch: ${{ github.event.inputs.forge_branch || 'main' }}

jobs:
  benchmark-forge:
    runs-on: ubuntu-latest
    container: ghcr.io/lballabio/quantlib-devenv:rolling

    name: ORE XAD+Forge (JIT AAD)

    steps:
      - name: Checkout ORE Engine
        uses: actions/checkout@v4
        with:
          repository: ${{ env.ore_repo }}
          ref: ${{ env.ore_branch }}
          path: Engine
          submodules: recursive

      - name: Checkout XAD-JIT
        uses: actions/checkout@v4
        with:
          repository: ${{ env.xad_repo }}
          ref: ${{ env.xad_branch }}
          path: xad-jit

      - name: Checkout Forge
        uses: actions/checkout@v4
        with:
          repository: ${{ env.forge_repo }}
          ref: ${{ env.forge_branch }}
          path: forge

      - name: Checkout ORE-Forge (for patches and integration)
        uses: actions/checkout@v4
        with:
          path: ORE-Forge

      - name: Apply patches to QuantLib
        run: |
          cd Engine/QuantLib
          for patch in ../../ORE-Forge/patches/*.patch; do
            if [ -f "$patch" ]; then
              echo "Applying: $patch"
              patch -p1 < "$patch"
            fi
          done

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2.12
        with:
          key: benchmark-ore-xad-forge
          max-size: 1G

      - name: Setup
        run: |
          apt-get update && apt-get install -y ninja-build ccache

      # Build Forge (pre-built to isolate AVX2 flags)
      - name: Build Forge
        run: |
          cd forge
          cmake -B build -S tools/packaging \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=$(pwd)/../install
          cmake --build build
          cmake --install build

      # Build ORE with XAD-JIT + Forge (no tests)
      - name: Configure ORE with XAD-JIT + Forge
        run: |
          cd Engine
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DBOOST_ROOT=/usr \
            -DCMAKE_PREFIX_PATH=$(pwd)/../install \
            -DQL_EXTERNAL_SUBDIRECTORIES="$(pwd)/../xad-jit;$(pwd)/../ORE-Forge" \
            -DQL_EXTRA_LINK_LIBRARIES=QuantLib-Risks \
            -DQL_NULL_AS_FUNCTIONS=ON \
            -DXAD_WARNINGS_PARANOID=OFF \
            -DQL_BUILD_TEST_SUITE=OFF \
            -DQL_BUILD_EXAMPLES=OFF \
            -DQL_BUILD_BENCHMARK=OFF \
            -DQLRISKS_DISABLE_AAD=OFF \
            -DQLRISKS_BUILD_TEST_SUITE=OFF \
            -DQLRISKS_ENABLE_FORGE_TESTS=OFF \
            -DQLRISKS_BUILD_BENCHMARK=OFF \
            -DORE_BUILD_DOC=OFF \
            -DORE_BUILD_EXAMPLES=ON \
            -DORE_BUILD_TESTS=OFF \
            -DORE_BUILD_SWIG=OFF

      - name: Build ORE
        run: |
          cd Engine/build
          cmake --build .

      # Run benchmark using ore executable with timing
      - name: Run Benchmark
        run: |
          cd Engine/Examples/Legacy/Example_3

          echo "=============================================="
          echo "ORE Example 3 CVA Benchmark - XAD+Forge"
          echo "=============================================="
          echo "XAD-JIT: ${{ env.xad_branch }}"
          echo "Forge: ${{ env.forge_branch }}"
          echo ""

          # Warmup
          echo "Running warmup iterations..."
          for i in 1 2 3; do
            echo "  Warmup $i/3..."
            ../../../build/App/ore Input/ore.xml > /dev/null 2>&1
          done
          echo ""

          # Benchmark
          echo "Running benchmark iterations..."
          for i in 1 2 3 4 5; do
            start=$(date +%s.%N)
            ../../../build/App/ore Input/ore.xml > /dev/null 2>&1
            end=$(date +%s.%N)
            elapsed=$(echo "$end - $start" | bc)
            echo "  Iteration $i/5: ${elapsed}s"
          done

      - name: Benchmark Summary
        run: |
          echo "## ORE Example 3 CVA Benchmark - XAD+Forge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ORE Version | ${{ env.ore_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| XAD-JIT | ${{ env.xad_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Forge | ${{ env.forge_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AAD | JIT-compiled (Forge backend) |" >> $GITHUB_STEP_SUMMARY
          echo "| Example | Example 3 (Swaption CVA) |" >> $GITHUB_STEP_SUMMARY
